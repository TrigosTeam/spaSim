---
title: "vignette"
author: 
  - name: Yuzhou Feng
    affiliation:
    - Peter MacCallum Cancer Centre
    email: Yuzhou.Feng@petermac.org
output: 
  BiocStyle::html_document:
    self_contained: yes
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: "none"
date: "`r doc_date()`"
package: "`r pkg_ver('spaSim')`"
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    crop = NULL ## Related to https://stat.ethz.ch/pipermail/bioc-devel/2020-April/016656.html
)
```


```{r vignetteSetup, echo=FALSE, message=FALSE, warning = FALSE}
## Track time spent on making the vignette
startTime <- Sys.time()

## Bib setup
library("RefManageR")

## Write bibliography information
bib <- c(
    R = citation(),
    BiocStyle = citation("BiocStyle")[1],
    knitr = citation("knitr")[1],
    RefManageR = citation("RefManageR")[1],
    rmarkdown = citation("rmarkdown")[1],
    sessioninfo = citation("sessioninfo")[1],
    testthat = citation("testthat")[1],
    spaSim = citation("spaSim")[1]
)
```

# Basics

## Install `spaSim`

`R` is an open-source statistical environment which can be easily modified to enhance its functionality via packages. `r Biocpkg("spaSim")` is a `R` package available via the [Bioconductor](http://bioconductor.org) repository for packages. `R` can be installed on any operating system from [CRAN](https://cran.r-project.org/) after which you can install `r Biocpkg("spaSim")` by using the following commands in your `R` session:

```{r "install"}
# if (!requireNamespace("BiocManager", quietly = TRUE)) {
#       install.packages("BiocManager")
#   }
# 
# BiocManager::install("spaSim")
# 
# ## Check that you have a valid Bioconductor installation
# BiocManager::valid()

# change to biocmanager later
# devtools::install()

library(spaSim) 
```

## Required knowledge

`r Biocpkg("spaSim")` is based on many other packages and in particular in those that have implemented the infrastructure needed for dealing with cell data. That is, packages like `r Biocpkg("SummarizedExperiment")`.

If you are asking yourself the question "Where do I start using Bioconductor?" you might be interested in [this blog post](http://lcolladotor.github.io/2014/10/16/startbioc/#.VkOKbq6rRuU).

## Asking for help

As package developers, we try to explain clearly how to use our packages and in which order to use the functions. But `R` and `Bioconductor` have a steep learning curve so it is critical to learn where to ask for help. The blog post quoted above mentions some but we would like to highlight the [Bioconductor support site](https://support.bioconductor.org/) as the main resource for getting help: remember to use the `spaSim` tag and check [the older posts](https://support.bioconductor.org/t/spaSim/). Other alternatives are available such as creating GitHub issues and tweeting. However, please note that if you want to receive help you should adhere to the [posting guidelines](http://www.bioconductor.org/help/support/posting-guide/). It is particularly critical that you provide a small reproducible example and your session information so package developers can track down the source of the error.

## Citing `spaSim`

We hope that `r Biocpkg("spaSim")` will be useful for your research. Please use the following information to cite the package and the overall approach. Thank you!

```{r "citation"}
## Citation info
citation("spaSim")
```

# Quick start to using `spaSim`

## Simulate individual image.
spaSim has a family of functions to simulate patterns.

### Simulate background cells.
Randomly generate spatial locations of 'background cells' prior to creating cell identities. The 'background cells' are the input... -todo finish
```{r}
bg <- simulate_background_cells(n_cells = 5000,
                                width = 2000,
                                height = 2000,
                                min_d = 10,
                                oversample = 1.5,
                                Phenotype="Others")
head(bg)
```

### Simulate mixed background
Randomly assign 'background cells' to the the specified cell identities in the specified proportions in an unstructured manner.
```{r}
#should force the same colours to the same index in names_of_mixing for all plots generated from these functions
#change names_of_mixing -> ident?
#change mixing_degree -> prop/prop_ident?
#do you need consistency between arguments for bioconductor? i.e. plot_image vs plotImage vs plot.image?
mix_bg <- simulate_mixing(background_sample = bg,
                          names_of_mixing = c("Tumour", "Immune", "Others"),
                          mixing_degree = c(0.2, 0.4, 0.4), 
                          plot.image = TRUE)
```

### Simulate clusters
First, specify the properties of clusters such their primary cell type, size, shape and location, and properties of any infiltrating cell types. Then randomly assign 'background cells' which lie within these clusters to the specified cell identities in the specified proportions.
```{r}
cluster_properties <- list(
                    C1 = list(name_of_cluster_cell = "Tumour", size = 300,
                              shape = "Oval", centre_loc = data.frame(x = 500, y = 500), 
                               infiltration_types = c("Immune1", "Others"), 
                               infiltration_proportions = c(0.1, 0.05)), 
                    C2 = list(name_of_cluster_cell = "Immune1", size = 500, 
                              shape = "Irregular", centre_loc = data.frame(x = 1500, y = 500), 
                              infiltration_types = c("Immune2", "Others"),
                              infiltration_proportions = c(0.1, 0.05)))

clusters <- simulate_clusters(background_sample = bg,
                  n_clusters = 2,
                  bg_type = "Others",
                  win = NULL,
                  properties_of_clusters = cluster_properties,
                  plot.image = TRUE)
```

### Simulate immune rings
First, specify the properties of immune rings such their primary (inner mass) and secondary (outer ring) cell types, size, shape, width and location. Properties of cells infiltrating into the inner mass or outer ring can also be set. Then randomly assign 'background cells' which lie within these clusters to the specified cell identities in the specified proportions.
```{r}
immune_ring_properties <- list(
    I1 = list(name_of_cluster_cell = "Tumour", size = 500, 
              shape = "Circle", centre_loc = data.frame(x = 930, y = 1000), 
              infiltration_types = c("Immune1", "Immune2", "Others"), 
              infiltration_proportions = c(0.15, 0.05, 0.05),
              name_of_ring_cell = "Immune1", immune_ring_width = 150,
              immune_ring_infiltration_types = c("Others"), 
              immune_ring_infiltration_proportions = c(0.15)), 
    I2 = list(name_of_cluster_cell = "Tumour", size = 400, shape = "Oval",
              centre_loc = data.frame(x = 1330, y = 1100), 
              infiltration_types = c("Immune1",  "Immune2", "Others"), 
              infiltration_proportions = c(0.15, 0.05, 0.05),
              name_of_ring_cell = "Immune1", immune_ring_width = 150,
              immune_ring_infiltration_types = c("Others"), 
              immune_ring_infiltration_proportions = c(0.15)))

rings <- simulate_immune_rings(
  background_sample = bg,
  bg_type = "Others",
  n_immune_rings = 2,
  win = NULL,
  properties_of_immune_rings = immune_ring_properties,
  plot.image = TRUE)

# Jojo - it may be worth highlighting that in these examples you are layering two shapes on top of each other and that an algorithm is used to make the inner mass and outer rings of the different shapes cohesive. Possibly, it is better for each functionality (clusters, immune rings, double rings, etc.) to be shown in its simplest possible form (like the code below), then show the layering in a later part of the vignette. Also worth showing that you can input a background already containing cell assignments into these functions, explain the layered construction of patterns, and to highlight which parts are deterministic (cluster/shape locations, shape, and size) and which are stochastic (cell assignments within clusters/shapes)

immune_ring_properties <- list(
    I1 = list(name_of_cluster_cell = "Tumour", size = 500, 
              shape = "Circle", centre_loc = data.frame(x = 930, y = 1000), 
              infiltration_types = c("Immune1", "Immune2", "Others"), 
              infiltration_proportions = c(0.15, 0.05, 0.05),
              name_of_ring_cell = "Immune1", immune_ring_width = 150,
              immune_ring_infiltration_types = c("Others"), 
              immune_ring_infiltration_proportions = c(0.15)))

rings <- simulate_immune_rings(
  background_sample = bg,
  bg_type = "Others",
  n_immune_rings = 1,
  win = NULL,
  properties_of_immune_rings = immune_ring_properties,
  plot.image = TRUE)
```

### Simulate double rings.
First, specify the properties of double rings such their primary (inner mass), secondary (inner ring), and tertiary (outer ring) cell types, size, shape, width and location. Properties of cells infiltrating into the inner mass or either ring can also be set. Then randomly assign 'background cells' which lie within these clusters to the specified cell identities in the specified proportions.
```{r}
double_ring_properties <- list(
    I1 = list(name_of_cluster_cell = "Tumour", size = 300, shape = "Circle", 
              centre_loc = data.frame(x = 1000, y = 1000), 
              infiltration_types = c("Immune1", "Immune2", "Others"), 
              infiltration_proportions = c(0.15, 0.05, 0.05), 
              name_of_ring_cell = "Immune1", immune_ring_width = 150,
              immune_ring_infiltration_types = c("Others"), 
              immune_ring_infiltration_proportions = c(0.15), 
              name_of_double_ring_cell = "Immune2", double_ring_width = 100,
              double_ring_infiltration_types = c("Others"), 
              double_ring_infiltration_proportions = c(0.15)),      
    I2 = list(name_of_cluster_cell = "Tumour", size = 300, shape = "Oval",
              centre_loc = data.frame(x = 1200, y = 1200), 
              infiltration_types = c("Immune1", "Immune2", "Others"), 
              infiltration_proportions = c(0.15, 0.05, 0.05),
              name_of_ring_cell = "Immune1", immune_ring_width = 150,
              immune_ring_infiltration_types = c("Others"), 
              immune_ring_infiltration_proportions = c(0.15), 
              name_of_double_ring_cell = "Immune2", double_ring_width = 100,
              double_ring_infiltration_types = c("Others"), 
              double_ring_infiltration_proportions = c(0.15)))

double_rings <- simulate_double_rings(
  background_sample = bg1,
  bg_type = "Others",
  n_double_rings = 2,
  win = NULL,
  properties_of_double_rings = double_ring_properties,
  plot.image = TRUE)
```

### Simulate vessels.
First, specify the properties of vessel structures such as their 
```{r}
vessles <- simulate_stripes(
  background_sample = bg1,
  n_stripe_type = 2,
  win = NULL,
  properties_of_stripes = list(
    S1 = list(number_of_stripes = 1, name_of_stripe_cell = "Others", 
              width_of_stripe = 80, infiltration_types = c("Immune"),
              infiltration_proportions = c(0.08)), 
    S2 = list(number_of_stripes = 5, name_of_stripe_cell = "Others", 
              width_of_stripe = 80, infiltration_types = c("Immune"), 
              infiltration_proportions = c(0.08))))
```

## Simulate multiple images with a pattern.

1. Simulate multiple background images with different proportions of cell types.
The example is 4 images with 10% Tumour cells and more and more Immune cells.
```{r}
bg_list <- 
multiple_background_images(
  background_sample = bg1,
  names_of_cell_types = c("Tumour", "Immune", "Others"),
  proportions_of_cell_types = list(rep(0.1, 4), seq(0, 0.3, 0.1), 
                                   seq(0.9, 0.6, -0.1)),
  plot.image = TRUE)

```
2. Simulate multiple images with clusters of different properties.
The example is 4 images with larger and larger tumour cluster sizes.
```{r}
cluster_list <- 
multiple_images_with_clusters(
  background_sample = bg1,
  cluster_shape = 2,
  infiltration = 0.1,
  cluster_size = seq(200, 500, 100),
  cluster_loc_x = 0,
  cluster_loc_y = 0,
  plot.image = TRUE
)
```

3. Simulate multiple images with immune rings of different properties.
The example is 3 images with wider and wider immune rings.

```{r}
immune_ring_list <- 
multiple_images_with_immune_rings(
  background_sample = bg1,
  cluster_size = 200,
  ring_shape = 1,
  infiltration = 0,
  ring_width = seq(50, 120, 30),
  cluster_loc_x = 0,
  cluster_loc_y = 0,
  ring_infiltration = 0.1,
  plot.image = TRUE
)
```

## Function TIS()
Function `TIS` simulate all possible patterns in one function. The patterns are simulated in the order of: background cells, mixed background cells, clusters (tumour/immune), immune rings, double immune rings, and vessels. 

Not all patterns are required for using this function. If a pattern is not needed, simply use `NULL` for the pattern args.

The example is simulating a background sample with a tumour clsuter on it.

```{r}
TIS(background_sample = NULL,
    n_cells = 5000,
    width = 2000,
    height = 2000,
    min_d = 10,
    n_clusters = 1,
    properties_of_clusters = list(
      C1 = list( name_of_cluster_cell = "Tumour", size = 300, shape = "Oval", 
                 centre_loc = data.frame("x" = 500, "y" = 500),
                 infiltration_types = c("Immune1", "Others"), 
                 infiltration_proportions = c(0.1, 0.05))),
    plot.image = TRUE)
```


# Citation
Here is an example of you can cite the package.

* `r Biocpkg("spaSim")` `r Citep(bib[["spaSim"]])`



# Reproducibility

The `r Biocpkg("spaSim")` package `r Citep(bib[["spaSim"]])` was made possible thanks to:

* R `r Citep(bib[["R"]])`
* `r Biocpkg("BiocStyle")` `r Citep(bib[["BiocStyle"]])`
* `r CRANpkg("knitr")` `r Citep(bib[["knitr"]])`
* `r CRANpkg("RefManageR")` `r Citep(bib[["RefManageR"]])`
* `r CRANpkg("rmarkdown")` `r Citep(bib[["rmarkdown"]])`
* `r CRANpkg("sessioninfo")` `r Citep(bib[["sessioninfo"]])`
* `r CRANpkg("testthat")` `r Citep(bib[["testthat"]])`

This package was developed using `r BiocStyle::Biocpkg("biocthis")`.


Code for creating the vignette

```{r createVignette, eval=FALSE}
## Create the vignette
library("rmarkdown")
system.time(render("vignette.Rmd", "BiocStyle::html_document"))

## Extract the R code
library("knitr")
knit("vignette.Rmd", tangle = TRUE)
```

Date the vignette was generated.

```{r reproduce1, echo=FALSE}
## Date the vignette was generated
Sys.time()
```

Wallclock time spent generating the vignette.

```{r reproduce2, echo=FALSE}
## Processing time in seconds
totalTime <- diff(c(startTime, Sys.time()))
round(totalTime, digits = 3)
```

`R` session information.

```{r reproduce3, echo=FALSE}
## Session info
library("sessioninfo")
options(width = 120)
session_info()
```



# Bibliography

This vignette was generated using `r Biocpkg("BiocStyle")` `r Citep(bib[["BiocStyle"]])`
with `r CRANpkg("knitr")` `r Citep(bib[["knitr"]])` and `r CRANpkg("rmarkdown")` `r Citep(bib[["rmarkdown"]])` running behind the scenes.

Citations made with `r CRANpkg("RefManageR")` `r Citep(bib[["RefManageR"]])`.

```{r vignetteBiblio, results = "asis", echo = FALSE, warning = FALSE, message = FALSE}
## Print bibliography
PrintBibliography(bib, .opts = list(hyperlink = "to.doc", style = "html"))
```
